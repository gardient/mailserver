#!/usr/bin/env bash

source "$INSTALLER_UTILS/env.sh"
source "$INSTALLER_UTILS/print.sh"
source "$INSTALLER_UTILS/installer-data.sh"

if _inst_step_hasrun "$(basename $0)"; then exit 0; fi

_inst_data_load "db"
_inst_data_load "passw"

__ensure_env MAILSRV_DBNAME_POSTFIX "postfix"
__ensure_env MAILSRV_DBNAME_RCMAIL "roundcube"
_inst_data_save "db" MAILSRV_DBNAME_POSTFIX "$MAILSRV_DBNAME_POSTFIX"
_inst_data_save "db" MAILSRV_DBNAME_RCMAIL "$MAILSRV_DBNAME_RCMAIL"

print_inf "creating databases: ['MAILSRV_DBNAME_POSTFIX':'$MAILSRV_DBNAME_POSTFIX','MAILSRV_DBNAME_RCMAIL':'$MAILSRV_DBNAME_RCMAIL']"

mysql <<-EOF
# create databases
CREATE DATABASE \`$MAILSRV_DBNAME_POSTFIX\`;
CREATE DATABASE \`$MAILSRV_DBNAME_RCMAIL\` CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_unicode_ci';
EOF

print_suc "DONE creating databases"

__ensure_env MAILSRV_DBUSERNAME_DB_SA "superadmin"
__ensure_env MAILSRV_DBUSERNAME_SA_POSTFIX_RO "sa-postfix-ro"
__ensure_env MAILSRV_DBUSERNAME_SA_DOVECOT_RO "sa-dovecot-ro"
__ensure_env MAILSRV_DBUSERNAME_SA_RC_PASS_RW "sa-rc-pass-rw"
__ensure_env MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW "sa-postfixadm-rw"
__ensure_env MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW "sa-roundcube-rw"
_inst_data_save "db" MAILSRV_DBUSERNAME_DB_SA "$MAILSRV_DBUSERNAME_DB_SA"
_inst_data_save "db" MAILSRV_DBUSERNAME_SA_POSTFIX_RO "$MAILSRV_DBUSERNAME_SA_POSTFIX_RO"
_inst_data_save "db" MAILSRV_DBUSERNAME_SA_DOVECOT_RO "$MAILSRV_DBUSERNAME_SA_DOVECOT_RO"
_inst_data_save "db" MAILSRV_DBUSERNAME_SA_RC_PASS_RW "$MAILSRV_DBUSERNAME_SA_RC_PASS_RW"
_inst_data_save "db" MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW "$MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW"
_inst_data_save "db" MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW "$MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW"

print_inf "creating users: ["
print_inf "    'MAILSRV_DBUSERNAME_DB_SA':'$MAILSRV_DBUSERNAME_DB_SA',"
print_inf "    'MAILSRV_DBUSERNAME_SA_POSTFIX_RO':'$MAILSRV_DBUSERNAME_SA_POSTFIX_RO',"
print_inf "    'MAILSRV_DBUSERNAME_SA_DOVECOT_RO':'$MAILSRV_DBUSERNAME_SA_DOVECOT_RO',"
print_inf "    'MAILSRV_DBUSERNAME_SA_RC_PASS_RW':'$MAILSRV_DBUSERNAME_SA_RC_PASS_RW',"
print_inf "    'MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW':'$MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW',"
print_inf "    'MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW':'$MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW'"
print_inf "]"

mysql <<- EOF
# create users
CREATE USER '$MAILSRV_DBUSERNAME_DB_SA'@'127.0.0.1'        IDENTIFIED BY '$MAILSRV_DB_SA_PASSW';
CREATE USER '$MAILSRV_DBUSERNAME_SA_POSTFIX_RO'@'127.0.0.1'     IDENTIFIED BY '$MAILSRV_SA_POSTFIX_RO_PASSW';
CREATE USER '$MAILSRV_DBUSERNAME_SA_DOVECOT_RO'@'127.0.0.1'     IDENTIFIED BY '$MAILSRV_SA_DOVECOT_RO_PASSW';
CREATE USER '$MAILSRV_DBUSERNAME_SA_RC_PASS_RW'@'127.0.0.1'     IDENTIFIED BY '$MAILSRV_SA_RC_PASS_RW_PASSW';
CREATE USER '$MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW'@'127.0.0.1'  IDENTIFIED BY '$MAILSRV_SA_POSTFIXADM_RW_PASSW';
CREATE USER '$MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW'@'127.0.0.1'   IDENTIFIED BY '$MAILSRV_SA_ROUNDCUBE_RW_PASSW';

# grant rights to users
GRANT ALL               ON *.*                              TO '$MAILSRV_DBUSERNAME_DB_SA'@'127.0.0.1' WITH GRANT OPTION;
GRANT SELECT            ON \`$MAILSRV_DBNAME_POSTFIX\`.*    TO '$MAILSRV_DBUSERNAME_SA_POSTFIX_RO'@'127.0.0.1';
GRANT SELECT            ON \`$MAILSRV_DBNAME_POSTFIX\`.*    TO '$MAILSRV_DBUSERNAME_SA_DOVECOT_RO'@'127.0.0.1';
GRANT SELECT, UPDATE    ON \`$MAILSRV_DBNAME_POSTFIX\`.*    TO '$MAILSRV_DBUSERNAME_SA_RC_PASS_RW'@'127.0.0.1';
GRANT ALL               ON \`$MAILSRV_DBNAME_POSTFIX\`.*    TO '$MAILSRV_DBUSERNAME_SA_POSTFIXADM_RW'@'127.0.0.1';
GRANT ALL               ON \`$MAILSRV_DBNAME_RCMAIL\`.*     TO '$MAILSRV_DBUSERNAME_SA_ROUNDCUBE_RW'@'127.0.0.1';
EOF

print_suc "DONE creating users"

_inst_step_success "$(basename $0)"
